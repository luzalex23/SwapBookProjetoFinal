<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>WebdexSwapBookv3 DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; padding: 20px; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 6px; }
    input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 10px 15px; margin: 5px 0; border: none; border-radius: 6px; cursor: pointer; background-color: #007bff; color: white; font-weight: bold; }
    button:hover { background-color: #0056b3; }
    #swaps-list li { border-bottom: 1px solid #ddd; padding: 10px 0; }
    #swaps-list li:last-child { border-bottom: none; }
    #status-message { margin: 10px 0; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebdexSwapBookv3</h1>
    <p>Interaja com o contrato inteligente na rede Sepolia.</p>
    <button id="connectMetaMask">üîå Conectar MetaMask</button>
    <button id="getOwnerValueButton">üìä Obter OwnerValue</button>
    <button id="getPendingSwapsButton">üìã Ver Swaps Pendentes</button>
    <p id="status-message">‚ùå N√£o conectado.</p>

    <h2>Criar Swap</h2>
    <div class="form-group">
      <label for="leftTokenAddress">Token a Vender (Endere√ßo):</label>
      <input type="text" id="leftTokenAddress">
    </div>
    <div class="form-group">
      <label for="leftTokenAmount">Quantidade a Vender:</label>
      <input type="text" id="leftTokenAmount">
    </div>
    <div class="form-group">
      <label for="rightTokenAddress">Token a Receber (Endere√ßo):</label>
      <input type="text" id="rightTokenAddress">
    </div>
    <div class="form-group">
      <label for="rightTokenAmount">Quantidade a Receber:</label>
      <input type="text" id="rightTokenAmount">
    </div>
    <button id="approveButton">‚úÖ 1. Aprovar Tokens</button>
    <button id="createSwapButton">üöÄ 2. Criar Swap</button>
    <button id="swapVendidos">3. Listar Swap Vendidos</button>

    <h2>Swaps Pendentes</h2>
    <ul id="swaps-list"></ul>
  </div>

  <script>
    let provider, signer, contract;
    const contractAddress = "0x39b1c83f07d37bB1F81ca80312285503d906cC4F";

   const contractABI = [
  { "inputs": [{ "internalType": "uint256", "name": "ownerValue_", "type": "uint256" }, { "internalType": "address", "name": "initialOwner", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" },
  { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "OwnableInvalidOwner", "type": "error" },
  { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "OwnableUnauthorizedAccount", "type": "error" },
  { "inputs": [], "name": "ReentrancyGuardReentrantCall", "type": "error" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "FeesWithdrawn", "type": "event" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": true, "internalType": "address", "name": "seller", "type": "address" }], "name": "SwapCancelled", "type": "event" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": true, "internalType": "address", "name": "seller", "type": "address" }, { "indexed": true, "internalType": "address", "name": "leftToken", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "leftAmount", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "rightToken", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "rightAmount", "type": "uint256" }], "name": "SwapCreated", "type": "event" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" }, { "indexed": true, "internalType": "address", "name": "seller", "type": "address" }], "name": "SwapExecuted", "type": "event" },
  { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "string", "name": "method", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "timeStamp", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transaction", "type": "event" },
  { "inputs": [{ "internalType": "uint256", "name": "swapId", "type": "uint256" }], "name": "cancelSwap", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "leftToken", "type": "address" }, { "internalType": "uint256", "name": "leftTokenAmount", "type": "uint256" }, { "internalType": "address", "name": "rightToken", "type": "address" }, { "internalType": "uint256", "name": "rightTokenAmount", "type": "uint256" }], "name": "createSwap", "outputs": [], "stateMutability": "payable", "type": "function" },
  { "inputs": [], "name": "getOwnerValue", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "getPendingSwaps", "outputs": [{ "components": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "address", "name": "seller", "type": "address" }, { "internalType": "address", "name": "leftToken", "type": "address" }, { "internalType": "uint256", "name": "leftTokenAmount", "type": "uint256" }, { "internalType": "address", "name": "rightToken", "type": "address" }, { "internalType": "uint256", "name": "rightTokenAmount", "type": "uint256" }], "internalType": "struct WebdexSwapBookv3.SwapInfo[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "getSoldSwaps", "outputs": [{ "components": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "address", "name": "seller", "type": "address" }, { "internalType": "address", "name": "leftToken", "type": "address" }, { "internalType": "uint256", "name": "leftTokenAmount", "type": "uint256" }, { "internalType": "address", "name": "rightToken", "type": "address" }, { "internalType": "uint256", "name": "rightTokenAmount", "type": "uint256" }], "internalType": "struct WebdexSwapBookv3.SwapInfo[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "swapId", "type": "uint256" }], "name": "swapTokens", "outputs": [], "stateMutability": "payable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "swaps", "outputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "address", "name": "seller", "type": "address" }, { "internalType": "address", "name": "leftToken", "type": "address" }, { "internalType": "uint256", "name": "leftTokenAmount", "type": "uint256" }, { "internalType": "address", "name": "rightToken", "type": "address" }, { "internalType": "uint256", "name": "rightTokenAmount", "type": "uint256" }, { "internalType": "uint8", "name": "status", "type": "uint8" }], "stateMutability": "view", "type": "function" },
  { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "withdrawFees", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
];


    const erc20Abi = [
      "function approve(address spender, uint256 amount) returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    async function connectWallet() {
      try {
        if (!window.ethereum) throw new Error("MetaMask n√£o encontrada");
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        const address = await signer.getAddress();
        document.getElementById("status-message").innerText = `‚úÖ Conectado: ${address.slice(0, 6)}...${address.slice(-4)}`;
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }

    async function getOwnerValue() {
      try {
        const value = await contract.getOwnerValue();
        document.getElementById("status-message").innerText = `üìä OwnerValue: ${ethers.formatEther(value)} ETH`;
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }

    async function getPendingSwaps() {
      try {
        const swaps = await contract.getPendingSwaps();
        const list = document.getElementById("swaps-list");
        list.innerHTML = "";
        if (swaps.length === 0) return list.innerHTML = "<li>Nenhum swap pendente.</li>";

        swaps.forEach(swap => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>ID:</strong> ${swap.id} <br>
            <strong>Vendedor:</strong> ${swap.seller} <br>
            <strong>Vende:</strong> ${swap.leftTokenAmount} de ${swap.leftToken} <br>
            <strong>Quer:</strong> ${swap.rightTokenAmount} de ${swap.rightToken}
          `;
          list.appendChild(li);
        });
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }

    async function approveToken() {
      try {
        const leftTokenAddress = document.getElementById("leftTokenAddress").value.trim();
        const leftAmount = document.getElementById("leftTokenAmount").value;
        const tokenContract = new ethers.Contract(leftTokenAddress, erc20Abi, signer);
        const decimals = await tokenContract.decimals();
        const amountParsed = ethers.parseUnits(leftAmount, decimals);
        const tx = await tokenContract.approve(contractAddress, amountParsed);
        await tx.wait();
        document.getElementById("status-message").innerText = `‚úÖ Token aprovado com sucesso.`;
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }

    async function createSwap() {
      try {
        const leftTokenAddress = document.getElementById("leftTokenAddress").value.trim();
        const leftAmount = document.getElementById("leftTokenAmount").value;
        const rightTokenAddress = document.getElementById("rightTokenAddress").value.trim();
        const rightAmount = document.getElementById("rightTokenAmount").value;
        const ownerValue = await contract.getOwnerValue();

        const leftToken = new ethers.Contract(leftTokenAddress, erc20Abi, signer);
        const rightToken = new ethers.Contract(rightTokenAddress, erc20Abi, signer);
        const leftDecimals = await leftToken.decimals();
        const rightDecimals = await rightToken.decimals();

        const leftAmountParsed = ethers.parseUnits(leftAmount, leftDecimals);
        const rightAmountParsed = ethers.parseUnits(rightAmount, rightDecimals);

        const tx = await contract.createSwap(
          leftTokenAddress,
          leftAmountParsed,
          rightTokenAddress,
          rightAmountParsed,
          { value: ownerValue }
        );
        await tx.wait();
        document.getElementById("status-message").innerText = `‚úÖ Swap criado com sucesso! Hash: ${tx.hash}`;
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }
      async function getSoldSwaps() {
      try {
        const swaps = await contract.getSoldSwaps();
        const list = document.getElementById("swaps-list");
        list.innerHTML = "";
        if (swaps.length === 0) return list.innerHTML = "<li>Nenhum swap aprovado.</li>";

        swaps.forEach(swap => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>ID:</strong> ${swap.id} <br>
            <strong>Vendedor:</strong> ${swap.seller} <br>
            <strong>Vende:</strong> ${swap.leftTokenAmount} de ${swap.leftToken} <br>
            <strong>Quer:</strong> ${swap.rightTokenAmount} de ${swap.rightToken}
          `;
          list.appendChild(li);
        });
      } catch (err) {
        document.getElementById("status-message").innerText = `‚ùå Erro: ${err.message}`;
      }
    }


    document.getElementById("connectMetaMask").addEventListener("click", connectWallet);
    document.getElementById("getOwnerValueButton").addEventListener("click", getOwnerValue);
    document.getElementById("getPendingSwapsButton").addEventListener("click", getPendingSwaps);
    document.getElementById("approveButton").addEventListener("click", approveToken);
    document.getElementById("createSwapButton").addEventListener("click", createSwap);
    document.getElementById("swapVendidos").addEventListener("click", getSoldSwaps);

  </script>
</body>
</html>
